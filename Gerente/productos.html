<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Productos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <img src="logo_blanco_horizontal.png" alt="Smartshop Logo" height="40">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#menu" aria-controls="menu" aria-expanded="false"
                    aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="menu">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="productos.html">Modelos</a></li>
                    <li class="nav-item"><a class="nav-link" href="registrar_etiqueta.html">Añadir Producto</a></li>
                    <li class="nav-item"><a class="nav-link" href="modificar_etiqueta.html">Modificar Productos</a></li>
                </ul>
                <!-- Campo de búsqueda integrado en la navbar -->
                <form class="d-flex ms-3" onsubmit="buscarProductoEnter(event)">
                    <input id="buscador" class="form-control me-2" type="search" placeholder="Buscar modelos" aria-label="Search" onkeyup="buscarProducto()">
                </form>
            </div>
        </div>
    </nav>

<div class="container mt-5">
    <div class="row align-items-center mb-4">
        <div class="col-md-6">
            <h2 class="mb-0">Lista de Modelos</h2>
            <p id="contadorProductos" class="text-muted"></p>
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
            <!-- Botón para abrir el modal -->
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#nuevoProductoModal">
                Añadir Modelo
            </button>
        </div>
    </div>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                <tr>
                    <th></th>
                    <th>Nombre</th>
                    <th>Precio</th>
                    <th>Descripción</th>
                    <th>Categoría</th>
                    <th>Pasillo</th>
                    <th>Estante</th>
                    <th>Stock</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody id="tablaBody">
                <tr><td colspan="6">Cargando modelos...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- MODAL PARA EDITAR PRODUCTO -->
    <div class="modal fade" id="productoModal" tabindex="-1" aria-labelledby="productoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productoModalLabel">Editar Modelo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modalProductoId">

                    <div class="mb-3">
                        <label for="modalNombre" class="form-label">Nombre</label>
                        <input type="text" id="modalNombre" class="form-control">
                    </div>

                    <div class="mb-3">
                        <label for="modalPrecio" class="form-label">Precio (€)</label>
                        <input type="number" id="modalPrecio" class="form-control" step="0.01">
                    </div>

                    <div class="mb-3">
                        <label for="modalDescripcion" class="form-label">Descripción</label>
                        <input type="text" id="modalDescripcion" class="form-control">
                    </div>

                    <div class="mb-3">
                        <label for="modalCategoria" class="form-label">Categoría</label>
                        <input type="text" id="modalCategoria" class="form-control">
                    </div>

                    <div class="mb-3">
                        <label for="modalPasillo" class="form-label">Pasillo</label>
                        <input type="text" id="modalPasillo" class="form-control">
                    </div>

                    <div class="mb-3">
                        <label for="modalEstante" class="form-label">Estante</label>
                        <input type="text" id="modalEstante" class="form-control">
                    </div>

                    <div class="mb-3">
                        <label for="modalStock" class="form-label">Stock</label>
                        <input type="text" id="modalStock" class="form-control" disabled>
                    </div>

                    <div class="mb-3">
                        <label for="modalImagen" class="form-label">URL de la Imagen</label>
                        <input type="text" id="modalImagen" class="form-control">
                        <img id="modalImagenPreview" src="" alt="Vista previa" class="img-fluid mt-2" style="max-height: 150px;">
                    </div>
                    <div class="mb-3">
                        <label for="modalImagen2" class="form-label">Imagen 2</label>
                        <input type="text" id="modalImagen2" class="form-control">
                        <img id="modalImagen2Preview" src="" alt="Vista previa" class="img-fluid mt-2" style="max-height: 150px;">
                    </div>
                    <div class="mb-3">
                        <label for="modalImagen3" class="form-label">Imagen 3</label>
                        <input type="text" id="modalImagen3" class="form-control">
                        <img id="modalImagen3Preview" src="" alt="Vista previa" class="img-fluid mt-2" style="max-height: 150px;">
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarCambios()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para añadir productos-->
    <div class="modal fade" id="nuevoProductoModal" tabindex="-1" aria-labelledby="productoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nuevoProductoModalLabel">Añadir Modelo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body" id="nuevoProductoModalContent">
                    <form id="formProducto">
                        <div class="mb-3">
                            <label for="nombre" class="form-label">Nombre</label>
                            <input type="text" id="nombre" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="importe" class="form-label">Precio</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="importe" name="importe" aria-label="Cantidad en Euros" required>
                                <span class="input-group-text">€</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="descripcion" class="form-label">Descripción</label>
                            <input type="text" id="descripcion" class="form-control" >
                        </div>
                        <div class="mb-3">
                            <label for="categoria" class="form-label">Categoría</label>
                            <input type="text" id="categoria" class="form-control" >
                        </div>
                        <div class="mb-3">
                            <label for="pasillo" class="form-label">Pasillo</label>
                            <input type="text" id="pasillo" class="form-control" >
                        </div>
                        <div class="mb-3">
                            <label for="estante" class="form-label">Estante</label>
                            <input type="text" id="estante" class="form-control" >
                        </div>
                        <div class="mb-3">
                            <label for="imagen" class="form-label">URL de la Imagen</label>
                            <input type="url" id="imagen" class="form-control" oninput="mostrarVistaPrevia(1)">
                            <img id="previewImagen" src="" alt="Vista previa de la imagen" class="img-fluid rounded shadow" style="max-height: 200px; display: none;">
                        </div>
                        <div class="mb-3">
                            <label for="imagen2" class="form-label">Imagen 2</label>
                            <input type="url" id="imagen2" class="form-control" oninput="mostrarVistaPrevia(2)">
                            <img id="previewImagen2" src="" alt="Vista previa de la imagen" class="img-fluid rounded shadow" style="max-height: 200px; display: none;">
                        </div>
                        <div class="mb-3">
                            <label for="imagen3" class="form-label">Imagen 3</label>
                            <input type="url" id="imagen3" class="form-control" oninput="mostrarVistaPrevia(3)">
                            <img id="previewImagen3" src="" alt="Vista previa de la imagen" class="img-fluid rounded shadow" style="max-height: 200px; display: none;">
                        </div>
                        <div class="text-center mb-4">
                            <img id="previewImagen" src="" alt="Vista previa de la imagen" class="img-fluid rounded shadow" style="max-height: 200px; display: none;">
                        </div>
                        <button type="submit" class="btn btn-success w-100">Guardar Modelo</button>
                        <div id="mensaje" class="mt-3 text-center"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <script>
        let products = [];
        let num_productos = 0;

        async function fetchProducts() {
            try {
                const response = await fetch("http://127.0.0.1:9876/modelos");
                const data = await response.json();
                products = data.data;
                console.log(products.length);
                displayProducts(products);
            } catch (error) {
                console.error("Error al obtener modelos:", error);
                document.getElementById("tablaBody").innerHTML = `<tr><td colspan="6">Error al cargar los datos</td></tr>`;
            }
        }

        function displayProducts(filteredProducts) {
            //Actualizar contador de productos
            num_productos = filteredProducts.length;
            document.getElementById("contadorProductos").textContent = `${num_productos} modelo(s) encontrado(s)`;
            const tablaBody = document.getElementById("tablaBody");
            tablaBody.innerHTML = ""; // Limpiar la tabla

            filteredProducts.forEach(producto => {
                let fila = document.createElement("tr");
                fila.setAttribute("id", `producto-${producto.id_modelo}`);

                fila.innerHTML = `
                    <td><img src="${producto.url_imagen || 'http://127.0.0.1:9876/img404'}" alt="Imagen" width="50" height="50"></td>
                    <td>${producto.nombre_modelo}</td>
                    <td>${producto.precio} €</td>
                    <td>${producto.descripcion || ''}</td>
                    <td>${producto.categoria || ''}</td>
                    <td>${producto.pasillo}</td>
                    <td>${producto.estante}</td>
                    <td>${producto.stock}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="modificarProducto('${producto.id_modelo}')">Modificar</button>
                        <button class="btn btn-danger btn-sm" onclick="eliminarProducto('${producto.id_modelo}')">Eliminar</button>
                    </td>
                `;

                tablaBody.appendChild(fila);
            });
        }
        // Función para buscar productos al pulsar enter
        function buscarProductoEnter(event) {
            if (event) event.preventDefault();  // Evita recargar la página

            buscarProducto();
        }
        // Función de búsqueda
        function buscarProducto() {
            const query = document.getElementById("buscador").value.toLowerCase();
            const filteredProducts = products.filter(product => product.nombre_modelo.toLowerCase().includes(query));
            console.log("Filtered Products:", filteredProducts);
            displayProducts(filteredProducts);  // Mostrar los productos filtrados
        }

        function eliminarProducto(productoId) {
            if (confirm("¿Estás seguro de que deseas eliminar este modelo?")) {
                console.log(productoId);
                let url= `http://127.0.0.1:9876/remove/modelo?id_modelo=${productoId}`;
                fetch(url, { method: "GET" })
                    .then(response => {
                        if (!response.ok) throw new Error("Error en la respuesta del servidor");
                        return response.json();
                    })
                    .then(data => {
                        console.log("Producto eliminado:", data);
                        document.getElementById(`producto-${productoId}`).remove(); // Eliminar la fila de la tabla
                        //Actualizar contador de productos
                        num_productos -= 1;
                        document.getElementById("contadorProductos").textContent = `${num_productos} producto(s) encontrado(s)`;

                    })
                    .catch(error => console.error("Error al eliminar el producto:", error));
            }
        }

        function modificarProducto(productoId) {
            //alert(`Función de modificar producto ${productoId} aún no implementada.`);
            abrirModal(productoId);
        }

        function abrirModal(id) {
            const producto = products.find(p => p.id_modelo === id);
            if (!producto) return;

            document.getElementById("modalProductoId").value = producto.id_modelo;
            document.getElementById("modalNombre").value = producto.nombre_modelo;
            document.getElementById("modalPrecio").value = producto.precio;
            document.getElementById("modalDescripcion").value = producto.descripcion || '';
            document.getElementById("modalCategoria").value = producto.categoria || '';
            document.getElementById("modalPasillo").value = producto.pasillo;
            document.getElementById("modalEstante").value = producto.estante;
            document.getElementById("modalStock").value = producto.stock;
            document.getElementById("modalImagen").value = producto.url_imagen;
            document.getElementById("modalImagenPreview").src = producto.url_imagen;
            document.getElementById("modalImagen2").value = producto.imagen2;
            document.getElementById("modalImagen2Preview").src = producto.imagen2;
            document.getElementById("modalImagen3").value = producto.imagen3;
            document.getElementById("modalImagen3Preview").src = producto.imagen3;

            let modal = new bootstrap.Modal(document.getElementById("productoModal"));
            modal.show();
        }

        async function guardarCambios() {
            const id = document.getElementById("modalProductoId").value;
            const nombre = document.getElementById("modalNombre").value;
            const precio = document.getElementById("modalPrecio").value;
            const descripcion = document.getElementById("modalDescripcion").value;
            const categoria = document.getElementById("modalCategoria").value;
            const pasillo = document.getElementById("modalPasillo").value;
            const estante = document.getElementById("modalEstante").value;
            const imagen = document.getElementById("modalImagen").value;
            const imagen2 = document.getElementById("modalImagen2").value;
            const imagen3 = document.getElementById("modalImagen3").value;

            const productoEditado = { id, nombre, precio, descripcion, categoria, pasillo, estante, imagen, imagen2, imagen3 };

            try {
                let url= `http://127.0.0.1:9876/edit/modelo?id_modelo=${id}&nombre_modelo=${nombre}&precio=${precio}&descripcion=${descripcion}&categoria=${categoria}&pasillo=${pasillo}&estante=${estante}&url_imagen=${imagen}&imagen2=${imagen2}&imagen3=${imagen3}`;
                console.log(url);
                fetch(url, { method: "GET" })
                    .then(response => {
                        if (!response.ok) throw new Error("Error en la respuesta del servidor");
                        return response.json();
                    })
                    .then(data => {
                        console.log("Producto editado:", data);

                    })
                    .catch(error => console.error("Error al editar el producto:", error));

                // Cerrar modal y actualizar tabla
                let modal = bootstrap.Modal.getInstance(document.getElementById("productoModal"));
                modal.hide();
                fetchProducts();
            } catch (error) {
                console.error("Error al actualizar producto:", error);
            }
        }

        document.getElementById("modalImagen").addEventListener("input", () => {
            document.getElementById("modalImagenPreview").src = document.getElementById("modalImagen").value;
        });
        //Función para añadir productos
        document.getElementById("formProducto").addEventListener("submit", async function(event) {
            event.preventDefault();

            const id_modelo = Math.floor(Math.random() * 1e10);
            console.log(id_modelo);

            const nombre_modelo = document.getElementById("nombre").value;
            const precio = document.getElementById("importe").value;
            const descripcion = document.getElementById("descripcion").value;
            const categoria = document.getElementById("categoria").value;
            const pasillo = document.getElementById("pasillo").value;
            const estante = document.getElementById("estante").value;
            const url_imagen = document.getElementById("imagen").value;
            const imagen2 = document.getElementById("imagen2").value;
            const imagen3 = document.getElementById("imagen3").value;

            // Construcción de la URL con parámetros
            let url = `http://127.0.0.1:9876/add/modelo?id_modelo=${id_modelo}&nombre_modelo=${nombre_modelo}&precio=${precio}`;
            if (descripcion){
                url += `&descripcion=${descripcion}`;
            }
            if (categoria){
                url += `&categoria=${categoria}`;
            }
            if (pasillo){
                url += `&pasillo=${pasillo}`;
            }
            if (estante){
                url += `&estante=${estante}`;
            }
            if (url_imagen){
                url += `&url_imagen=${url_imagen}`;
            }
            if(imagen2){
                url += `&imagen2=${imagen2}`;
            }
            if(imagen3){
                url += `&imagen3=${imagen3}`;
            }

            try {
                const response = await fetch(url, {method: "GET"});
                const data = await response.json();
                console.log(response);
                console.log(data);

                if (response.ok) {
                    if (data["success"] === false) {
                        document.getElementById("mensaje").innerHTML = `<div class="alert alert-danger">Ha ocurrido un error inesperado</div>`;
                        return;
                    }
                    document.getElementById("mensaje").innerHTML = `<div class="alert alert-success">Modelo añadido correctamente.</div>`;
                    document.getElementById("formProducto").reset();
                    // Esto borra el src de la vista previa
                    borrarVistaPrevia();
                } else {
                    document.getElementById("mensaje").innerHTML = `<div class="alert alert-danger">Error: ${data.message}</div>`;
                }
            } catch (error) {
                document.getElementById("mensaje").innerHTML = `<div class="alert alert-danger">Error en la conexión con el servidor.</div>`;
            }
        });
        // Función para mostrar la vista previa de la imagen
        function mostrarVistaPrevia(numero) {
            const input = document.getElementById(`imagen${numero === 1 ? '' : numero}`);
            const preview = document.getElementById(`previewImagen${numero === 1 ? '' : numero}`);

            if (input && preview) {
                const url = input.value;
                if (url) {
                    preview.src = url;
                    preview.style.display = "block";
                } else {
                    preview.style.display = "none";
                }
            }
        }

        function borrarVistaPrevia() {
            const preview = document.getElementById("previewImagen");
            preview.src = "";
            preview.style.display = "none";
        }

        // Recargar la página al cerrar el modal de añadir producto
        const modalNuevoProducto = document.getElementById('nuevoProductoModal');

        modalNuevoProducto.addEventListener('hidden.bs.modal', function () {
            location.reload(); // Recarga la página al cerrar el modal
        });

        // Llamamos a la función cuando se cargue la página
        document.addEventListener("DOMContentLoaded", fetchProducts);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>